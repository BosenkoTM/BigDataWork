# Практическая работа №2. Изучение и применение различных типов NoSQL баз данных на бизнес-кейсах

---

## Цель работы
Сформировать навыки проектирования и реализации полиглотной системы хранения данных (Polyglot Persistence) для решения бизнес-задач. Студенты научатся разворачивать среду, работать с документо-ориентированными (MongoDB), колоночными (Cassandra) и графовыми (GraphDB/Neo4j) базами данных, а также применять их для построения рекомендательных систем и аналитики.

**Бизнес-кейс.** Разработка аналитического ядра для стриминговой платформы (аналог Netflix/Кинопоиск). Вам необходимо хранить каталог контента, профили пользователей, логи просмотров и граф связей для построения рекомендаций.

**Задачи:**
-  Развернуть Docker-контейнеры с необходимыми СУБД.
-  **MongoDB.** Реализовать хранение каталога контента и профилей (CRUD).
-  **Cassandra.** Реализовать запись потоковых логов (действия пользователей).
-  **GraphDB (SPARQL).** Загрузить RDF-граф знаний о фильмах и выполнить сложные поисковые запросы для рекомендательной системы.
-  Провести бизнес-анализ полученных данных.

---

## Необходимое ПО и окружение
Работа выполняется на виртуальной машине с образом **`devops_dba_25.ova`**.

**Инструменты и доступ:**
| Продукт | Тип БД | URL / Доступ | Назначение в бизнес-кейсе |
|---|---|---|---|
| **MongoDB** | Document | `http://localhost:28203` (Mongo-Express)<br>`http://localhost:28204` (Admin Mongo) | Каталог товаров/фильмов, данные пользователей. |
| **Cassandra** | Wide-Column | `http://localhost:28200` (Cassandra-Web)<br>`cqlsh` | Логирование действий, история просмотров, временные ряды. |
| **GraphDB** | Graph (RDF) | `http://localhost:7200` (или `http://localhost:28080` через Zeppelin) | Граф связей (Актер-Фильм-Жанр), рекомендательная система. |
| **Redis** | Key-Value | `http://localhost:28119` (Redis Commander) | Кэширование сессий (опционально). |

**Источник данных:**
Для выполнения работы используются открытые RDF-датасеты (Linked Open Data) по кинематографу (например, LinkedMDB или DBpedia subset), которые необходимо загрузить в GraphDB.

---

## Ход выполнения работы

### Шаг 1. Запуск инфраструктуры
-  Подключитесь к виртуальной машине.
-  Перейдите в рабочую директорию и запустите контейнеры:
    ```bash
    cd ~/Downloads/dba/nonrel/graphdb
    # Если контейнеры запущены, остановите их для чистого старта
    sudo docker compose stop
    # Запуск
    sudo docker compose start
    ```
-  Убедитесь, что веб-интерфейсы (см. таблицу выше) доступны в браузере.

### Шаг 2. Загрузка данных (ETL)
**Для GraphDB:**
-  Откройте интерфейс GraphDB.
-  Создайте репозиторий `movies_repo`.
-  Импортируйте предоставленный RDF-файл (Turtle/N-Triples) с данными о фильмах (файл находится внутри образа или скачивается по ссылке из материалов курса).

**Для MongoDB и Cassandra:**
Студент должен самостоятельно наполнить базы тестовыми данными (минимум 10-20 записей), соответствующими логике задания, используя скрипты на Python/JS или встроенные интерфейсы.

---

## Варианты индивидуальных заданий

В каждом варианте необходимо решить три подзадачи, формирующие сквозной процесс анализа данных.
*   **Задание 1 (NoSQL Operations).** Работа с MongoDB или Cassandra (администрирование, CRUD, агрегация).
*   **Задание 2 (Graph Analysis).** Сложные SPARQL-запросы к графу знаний для поиска связей.
*   **Задание 3 (Business Insight).** Аналитическая записка или вывод на основе данных (например, "В какой жанр инвестировать?").

**Вариант выбирается согласно номеру студента в списке группы.**

| № | **Задание 1 (MongoDB/Cassandra)**<br>Управление данными | **Задание 2 (GraphDB / SPARQL)**<br>Поиск связей и рекомендаций | **Задание 3 (Бизнес-аналитика)**<br>Выводы и метрики |
|---|---|---|---|
| 1 | **MongoDB.** Создать коллекцию `users`. Добавить пользователей с разными подписками (Premium, Basic). Найти всех Premium пользователей. | Найдите всех актеров, снимавшихся в фильме "The Matrix", и режиссеров, которые также являются актерами. | Проанализируйте, какие жанры чаще всего снимают режиссеры-актеры. Выгодно ли это? |
| 2 | **Cassandra.** Создать таблицу `logs` (user_id, timestamp, action). Записать 5 событий просмотра. | Найдите фильмы, где главный актер и режиссер — одно лицо, и отфильтруйте черно-белые фильмы. | Определите, есть ли корреляция между черно-белым форматом и рейтингом фильма (гипотеза). |
| 3 | **MongoDB.** Создать коллекцию `movies_meta`. Добавить документы с вложенными массивами жанров. Найти фильмы с жанром "Drama". | Найдите фильмы 90-х годов, в которых снялся Keanu Reeves, отсортируйте по количеству комментариев. | Оцените популярность актера Keanu Reeves в 90-е по количеству комментариев к его фильмам. |
| 4 | **Cassandra.** Создать таблицу `ratings` (movie_id, user_id, score). Вывести средний рейтинг (через приложение или cqlsh агрегацию). | Найдите режиссеров, снявших >5 фильмов, и выведите фильмы с участием Johnny Depp. | Составьте портрет "успешного режиссера": зависит ли продуктивность от работы с топ-актерами? |
| 5 | **MongoDB.** Обновить цены подписок в коллекции `subscriptions`. Увеличить стоимость для "Basic" на 10%. | Получите список фильмов и режиссеров, снявших более 10 фильмов. Выделите цветные фильмы с >100 комментариями. | Сделайте вывод о жизнеспособности цветного кино против ч/б на основе вовлеченности (комментариев). |
| 6 | **Cassandra.** Реализовать TTL (Time To Live) для таблицы `session_tokens`. Данные должны удаляться через 60 секунд. | Найдите все фильмы, в которых снимались два конкретных актера вместе. Получите актеров из "The Matrix". | Предложите стратегию "парного кастинга": какие дуэты актеров наиболее успешны? |
| 7 | **MongoDB.** Использовать индексацию. Создать индекс по полю `email` в `users` и объяснить `explain()`. | Найдите фильмы 2010-х годов с рейтингом >7.0. Найдите фильмы с одинаковыми актерами и режиссерами. | Проанализируйте тренд качества кино (по рейтингу) в 2010-х годах. |
| 8 | **Cassandra.** Создать Keyspace с репликацией 1. Создать таблицу `favorites` (user_id, movie_list). | Найдите фильмы, где играли актеры из "The Matrix". Сортируйте комедии по убыванию комментариев. | Оцените влияние "звездного состава" (из Матрицы) на популярность других жанров (комедий). |
| 9 | **MongoDB.** Агрегация. Посчитать количество пользователей в каждом городе (group by city). | Найдите фильмы с >1000 комментариев и фильмы, снятые до 1980 года, где актер и режиссер совпадают. | Сравните вовлеченность аудитории (комментарии) в классических и современных фильмах. |
| 10 | **Cassandra.** Выполнить Batch-запрос на вставку нескольких логов одновременно. | Найдите фильмы режиссера на "C" и фильмы с участием Leonardo DiCaprio и Christopher Nolan. | Оцените вклад Кристофера Нолана и Ди Каприо в индустрию (на основе количества найденных фильмов). |
| 11 | **MongoDB.** Текстовый поиск. Найти фильмы, в описании которых есть слово "Action". | Найдите фильмы 90-х, где Keanu Reeves играл у Lana Wachowski. Фильмы с рейтингом >9.0. | Является ли тандем Ривз-Вачовски гарантией высокого рейтинга? Обоснование. |
| 12 | **Cassandra.** Изменить схему таблицы (ALTER TABLE), добавить поле `device_type`. | Найдите фантастику 80-х и фильмы с Robert Downey Jr. и Chris Hemsworth. | Сравните популярность жанра Sci-Fi в 80-е и в эпоху Marvel (на примере Дауни мл.). |
| 13 | **MongoDB.** Валидация схемы. Задать правило, что поле `age` должно быть int. | Найдите триллеры, где снимались Scarlett Johansson и Chris Evans. Фильмы до 1970 года. | Анализ целевой аудитории триллеров с участием звезд Marvel (Йоханссон/Эванс). |
| 14 | **Cassandra.** Использовать кластеризацию (Clustering Key) для сортировки логов по времени. | Найдите фильмы с Johnny Depp и Helena Bonham Carter. Фильмы 2015 года с комментариями <50. | Оценка нишевости фильмов 2015 года: почему у некоторых мало комментариев? |
| 15 | **MongoDB.** Map-Reduce (или Aggregation). Посчитать средний возраст пользователей. | Найдите фильмы 90-х с Tom Cruise и Nicole Kidman. Фильмы с Brad Pitt и Angelina Jolie. | Сравнение "звездных пар": Круз/Кидман против Питт/Джоли. Чьи фильмы популярнее? |
| 16 | **Cassandra.** Выборка с фильтрацией (ALLOW FILTERING) — понять риски производительности. | Найдите черно-белые фильмы до 2000 года. Сортируйте фильмы по комментариям (возрастание). | Анализ "андерграунда": какие фильмы имеют наименьшее обсуждение и почему? |
| 17 | **MongoDB.** Lookup (Join). Объединить коллекции `orders` и `products`. | Фильмы James Cameron. Фильмы с Dwayne Johnson и Vin Diesel. Комментарии <500. | Сравнение блокбастеров: режиссерское кино (Кэмерон) против экшн-франшиз (Дизель). |
| 18 | **Cassandra.** Работа с коллекциями (Set/List) внутри ячейки таблицы Cassandra. | Фильмы Angelina Jolie и Brad Pitt. Драмы 2000-х с >1000 комментариев. | Анализ жанра Драма в 2000-х: какие факторы влияли на виральность (обсуждаемость)? |
| 19 | **MongoDB.** Экспорт и импорт данных (mongoexport/mongoimport) в JSON. | Фильмы Keanu Reeves и Laurence Fishburne. Боевики с рейтингом >7.0. | Эволюция жанра боевик: как дуэт из Матрицы повлиял на стандарты жанра. |
| 20 | **Cassandra.** Работа со счетчиками (Counter columns) для подсчета просмотров. | Фильмы Leonardo DiCaprio после 2000 года. Ужасы с рейтингом >9.0. | Анализ карьеры Ди Каприо: как часто он снимается в высокорейтинговых фильмах ужасов? |
| 21 | **MongoDB.** Найти документы, где поле массива содержит определенное значение (`$elemMatch`). | Фильмы с Tom Hanks. Фильмы с >5 актерами и >200 комментариями. | Влияет ли размер актерского состава (каста) на обсуждаемость фильма? |
| 22 | **Cassandra.** Создать Materialized View для поиска по не-ключевому полю. | Фильмы Meryl Streep и Robert Redford. Фильмы до 1980 года с рейтингом <5.0. | Анализ провалов: какие факторы приводили к низкому рейтингу в классическом кино? |
| 23 | **MongoDB.** Удаление дубликатов или поиск дублирующихся записей. | Фильмы Morgan Freeman. Фэнтези после 2010 года. Рейтинг <6.0. | Кризис жанра Фэнтези после 2010 года: анализ низкорейтинговых картин. |
| 24 | **Cassandra.** Использование UDT (User Defined Types) для адреса пользователя. | Фильмы Natalie Portman. Приключения с Keanu Reeves. Фильмы до 1990 года. | Сравнение приключенческих фильмов разных эпох (до 90-х и современные). |
| 25 | **MongoDB.** capped collections (кольцевые коллекции) для логов. | Фильмы Tom Hanks и Julia Roberts. Фильмы Nicole Kidman и Tom Cruise до 1980 года. | Ретроспективный анализ: романтические комедии и их звезды. |
| 26 | **Cassandra.** Настройка Consistency Level (Quorum vs One) при чтении. | Фильмы Brad Pitt. Ужасы с рейтингом >8.0. Фильмы R. Downey Jr. и C. Hemsworth. | Может ли актер боевиков (Питт) успешно сниматься в высокорейтинговых ужасах? |
| 27 | **MongoDB.** Поиск с использованием регулярных выражений (Regex). | Фильмы Johnny Depp и Helena Bonham Carter. Фильмы до 1980 (актер=режиссер). | Феномен "авторского кино" до 1980 года против тандемов (Депп/Картер). |
| 28 | **Cassandra.** Работа с LightWeight Transactions (IF NOT EXISTS). | Фильмы после 2000 года, где актер=режиссер. Фильмы с рейтингом >7.0. | Растет ли тренд на то, чтобы актеры становились режиссерами в 21 веке? |
| 29 | **MongoDB.** Геопространственный поиск (`$near`) — найти пользователей рядом. | Фильмы с рейтингом <5.0, но >500 комментариев. Драмы до 1990 с рейтингом >7.0. | Феномен "так плохо, что даже хорошо": анализ фильмов с низким рейтингом, но высокой обсуждаемостью. |
| 30 | **Cassandra.** Сжатие таблиц. Настройка стратегии компрессии. | Фильмы Keanu Reeves. Фильмы с рейтингом >8.0. Актеры=Режиссеры. | Влияние "Киану Ривза" на общий рейтинг фильмов. Статистический обзор. |
| 31 | **MongoDB.** Шардинг. Описать стратегию шардинга для коллекции `logs`. | Найдите все фильмы жанра "Comedy", снятые в 2020-х годах. | Анализ состояния комедийного жанра в последние годы. |
| 32 | **Cassandra.** Repair. Описать процесс восстановления узла. | Найдите актеров, которые работали с режиссером Quentin Tarantino. | Создание "дерева связей" Тарантино: есть ли у него "любимые" актеры? |
| 33 | **MongoDB.** Security. Создать пользователя с правами `readWrite`. | Найдите фильмы с самым длинным названием. Выведите их жанры. | Маркетинговый анализ: влияет ли длина названия на запоминаемость (через кол-во комментариев)? |
| 34 | **Cassandra.** Backup. Создать снапшот таблицы. | Найдите фильмы, получившие Оскар (если есть в данных) или с рейтингом 10.0. | Анализ шедевров: что объединяет фильмы с идеальным рейтингом? |
| 35 | **MongoDB.** GridFS. Загрузить картинку/файл в базу (концептуально или кодом). | Найдите документальные фильмы. Сравните их средний рейтинг с боевиками. | Сравнительный анализ интереса аудитории к правде (док) и вымыслу (боевики). |
| 36 | **Cassandra.** Tracing. Включить трассировку запроса и проанализировать вывод. | Найдите фильмы, где снималось более 20 актеров. | "Большой каст": гарантирует ли множество актеров успех фильму? |
| 37 | **MongoDB.** `$lookup` с pipeline. Сложное объединение. | Найдите фильмы, выпущенные в одной и той же стране (например, France). | Анализ французского кинематографа в базе: жанровые предпочтения. |
| 38 | **Cassandra.** Secondary Index. Создать и использовать вторичный индекс. | Найдите фильмы с ключевым словом "Love" в названии. | Семантический анализ: насколько успешны фильмы о любви? |
| 39 | **MongoDB.** Change Streams. Подписаться на изменения в коллекции. | Найдите фильмы, продолжительность которых более 3 часов. | Анализ усидчивости зрителя: рейтинг длинных фильмов. |
| 40 | **Cassandra.** Stress test. Запустить `cassandra-stress` утилиту. | Найдите фильмы, у которых нет жанра (Unknown). | Работа с "грязными данными": сколько фильмов выпадает из аналитики и почему? |

---

## Требования к отчетности

Работа сдается в виде ссылки на репозиторий (GitHub/GitVerse).

**Структура репозитория:**
-  **`docker-compose.yml`** — файл запуска среды.
-  **`scripts/`** — папка со скриптами (JS для Mongo, CQL для Cassandra, SPARQL запросы).
-  **`data/`** — примеры используемых данных (не загружать большие дампы, только сэмплы).
-  **`Report_Lab2.md`** — отчет о выполнении.

**Содержание отчета:**
*   **Введение.** Описание бизнес-кейса и выбранного стека технологий.
*   **Развертывание.** Скриншоты запущенных контейнеров и веб-интерфейсов.
*   **Выполнение Задания 1 (NoSQL).** Код запросов (insert, find, update) и скриншоты результатов. Обоснование выбора модели данных.
*   **Выполнение Задания 2 (GraphDB).** Текст SPARQL-запросов и скриншоты графов/таблиц с ответами.
*   **Выполнение Задания 3 (Analytics).** Бизнес-интерпретация результатов. Ответ на поставленный в варианте вопрос.
*   **Выводы.** Преимущества полиглотного подхода (почему для графа взяли GraphDB, а для логов Cassandra?).

---

## Критерии оценки

| Категория | Критерий | Баллы |
| :--- | :--- | :--- |
| **1. Инфраструктура и NoSQL (MongoDB/Cassandra)** | **6 баллов** | |
| | Успешный запуск контейнеров, доступность интерфейсов. | 2 |
| | Выполнено Задание 1: Созданы базы/коллекции, данные загружены. | 2 |
| | Выполнены CRUD операции и специфические задачи варианта (индексы, TTL и т.д.). | 2 |
| **2. Графовые базы данных (GraphDB/SPARQL)** | **6 баллов** | |
| | Данные (RDF) успешно загружены в репозиторий. | 2 |
| | SPARQL-запросы составлены синтаксически верно и возвращают корректные данные. | 4 |
| **3. Бизнес-аналитика и выводы** | **4 балла** | |
| | Проведен анализ полученных данных (Задание 3). | 2 |
| | Сделан обоснованный бизнес-вывод (инсайт), а не просто констатация факта. | 2 |
| **4. Качество отчета и репозитория** | **4 балла** | |
| | Репозиторий структурирован, есть README, код читаем. | 2 |
| | Отчет полный, содержит скриншоты, пояснения к каждому шагу. | 2 |
| **Итого** | | **20** |
```